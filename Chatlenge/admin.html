<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatlenge — Admin Panel 🛠️</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  <!-- Barre navigation -->
  <nav class="flex justify-between items-center p-4 bg-gray-800 shadow-md">
    <h1 class="text-2xl font-bold text-indigo-400">Admin Panel 🛠️</h1>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-md">Déconnexion</button>
  </nav>

  <main class="flex-1 p-6 max-w-5xl mx-auto">
    <h2 class="text-2xl font-bold text-indigo-300 mb-6">👥 Liste des utilisateurs</h2>
    <div id="usersList" class="space-y-3"></div>

    <h2 class="text-2xl font-bold text-yellow-400 mt-10 mb-4">📢 Annonce globale</h2>
    <textarea id="announcementInput" placeholder="Message à tous les joueurs..." class="w-full bg-gray-700 p-3 rounded-md mb-3"></textarea>
    <button id="sendAnnouncementBtn" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-md">Envoyer</button>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCj5WZ9CLQs8syiptj8YuYe2qUN2JuXzPU",
    authDomain: "chatlenge-713ad.firebaseapp.com",
    projectId: "chatlenge-713ad",
    storageBucket: "chatlenge-713ad.firebasestorage.app",
    messagingSenderId: "186225402929",
    appId: "1:186225402929:web:00c68622f68aac5ba12110"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = JSON.parse(localStorage.getItem("connectedUser"));
    if (!user) window.location.href = "login.html";

    // Protection : seuls les admins ou gérant peuvent voir cette page
    const userSnap = await getDocs(collection(db, "users"));
    let role;
    userSnap.forEach(u => {
      if (u.id === user.username) role = u.data().role;
    });
    if (role !== "admin" && role !== "gerant") {
      alert("Accès refusé !");
      window.location.href = "index.html";
    }

    // Affichage liste users
    const usersList = document.getElementById("usersList");
    const usersData = await getDocs(collection(db, "users"));
    usersList.innerHTML = "";
    usersData.forEach(docSnap => {
      const u = docSnap.data();
      const div = document.createElement("div");
      div.className = "bg-gray-800 p-3 rounded-md flex justify-between items-center";
      div.innerHTML = `
        <div>
          <p class="font-semibold text-indigo-300">${u.username}</p>
          <p class="text-gray-400 text-xs">${u.email}</p>
          <p class="text-gray-400 text-xs">Rôle: ${u.role || "user"} | Points: ${u.points || 0}</p>
        </div>
        <div class="space-x-2">
          <button class="bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded text-xs addPoints" data-id="${u.username}">+100</button>
          <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs banUser" data-id="${u.username}">Bannir</button>
        </div>
      `;
      usersList.appendChild(div);
    });

    // Ajouter des points
    document.querySelectorAll(".addPoints").forEach(btn => {
      btn.addEventListener("click", async e => {
        const pseudo = e.target.dataset.id;
        const ref = doc(db, "users", pseudo);
        await updateDoc(ref, { points: (await (await getDocs(collection(db, "users"))).docs.find(d => d.id === pseudo).data().points) + 100 });
        alert(`+100 points ajoutés à ${pseudo}`);
        window.location.reload();
      });
    });

    // Bannir un joueur
    document.querySelectorAll(".banUser").forEach(btn => {
      btn.addEventListener("click", async e => {
        const pseudo = e.target.dataset.id;
        const ref = doc(db, "users", pseudo);
        await updateDoc(ref, { banned: true });
        alert(`${pseudo} a été banni.`);
      });
    });

    // Envoyer annonce
    document.getElementById("sendAnnouncementBtn").addEventListener("click", async () => {
      const text = document.getElementById("announcementInput").value.trim();
      if (!text) return alert("Message vide !");
      await addDoc(collection(db, "announcements"), {
        from: user.username,
        text,
        timestamp: Date.now()
      });
      alert("Annonce envoyée !");
      document.getElementById("announcementInput").value = "";
    });

    // Déconnexion
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("connectedUser");
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
